@page "/CreateReport"
@using MediatR.NotificationPublishers
<MudForm @ref="_form" @bind-IsValid="@_success" @bind-Errors="@_errors" ReadOnly="false">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h5" GutterBottom="true">Create Report</MudText>
            <MudGrid>
                <MudItem sm="12" md="6">
                    <MudSelect T="Agency" @bind-Value="_report.Agency" Variant="Variant.Filled" Label="Agency" AnchorOrigin="Origin.BottomCenter" RequiredError="Agency must be selected">
                        @foreach (var agency in _agencies)
                        {
                            <MudSelectItem Value="@agency" />
                        }
                    </MudSelect>
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudSelect T="IncidentType" @bind-Value="_report.IncidentType" Variant="Variant.Filled" Label="Incident Type" AnchorOrigin="Origin.BottomCenter" RequiredError="Incient Type must be selected">
                        @foreach (var incidentType in _incidentTypes)
                        {
                            <MudSelectItem Value="@incidentType" />
                        }
                    </MudSelect>
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudDatePicker Label="Date" @bind-Date="_report.Date" Editable="true" Required="false" />
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudTimePicker Label="Time" @bind-Time="_report.Time" Editable="true" Required="_report?.Agency?.RequiresTime ?? false" />
                </MudItem>

            </MudGrid>
            <MudGrid>
                <MudItem sm="12" md="6">
                    <MudNumericField Immediate="false" Label="Miles Driven" Format="N1" T="double?" @bind-Value="_report.Miles" />
                </MudItem>
            </MudGrid>
        </MudItem>
        <MudItem xs="12">
            <MudText Typo="Typo.h5" GutterBottom="false">Location</MudText>
            <MudGrid>
                <MudItem sm="12" md="6">
                    <MudTextField Label="Address" @bind-Value="_report.Location.Address" Required="true" />
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudTextField Label="City" @bind-Value="_report.Location.City" Required="true" />
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudTextField Label="State" @bind-Value="_report.Location.State" Required="true" />
                </MudItem>
                <MudItem sm="12" md="6">
                    <MudTextField Label="Zip" @bind-Value="_report.Location.Zip" Required="false" />
                </MudItem>
            </MudGrid>
        </MudItem>
        <MudItem xs="12">
            <MudGrid>
                <MudItem xs="8"><MudText Typo="Typo.h5" GutterBottom="false">People</MudText></MudItem>
                <MudItem xs="4" Class="d-flex justify-end"><MudButton Variant="Variant.Filled" Color="Color.Primary" @onclick="AddPerson">Add Person</MudButton></MudItem>
            </MudGrid>
            <MudList>
                @foreach (var person in _report.People)
                {
                    <MudListItem>
                        <MudCard Outlined="true">
                            <MudGrid>
                                <MudItem sm="12" md="6" lg="4">
                                    <MudSelect @bind-Value="person.Type" Variant="Variant.Filled" Label="Type" AnchorOrigin="Origin.BottomCenter" RequiredError="Type must be selected">
                                        @foreach (PersonType personType in Enum.GetValues(typeof(PersonType)))
                                        {
                                            <MudSelectItem Value="personType">@personType</MudSelectItem>
                                        }
                                    </MudSelect>
                                </MudItem>
                                <MudItem sm="12" md="6" lg="4">
                                    @if (person.Type == PersonType.Victim)
                                    {
                                        <MudDatePicker Label="Date of Birth" @bind-Date="person.DateOfBirth" Editable="true" Required="false" />
                                    }
                                </MudItem>
                                <MudItem sm="12">
                                    <MudGrid>
                                        <MudItem sm="12" md="6" lg="4">
                                            <MudTextField Label="First Name" @bind-Value="person.FirstName" Required="true" />
                                        </MudItem>
                                        <MudItem sm="12" md="6" lg="4">
                                            <MudTextField Label="Last Name" @bind-Value="person.LastName" Required="true" />
                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                                @if (person.AllowPhoneNumber())
                                {
                                    <MudItem sm="12">
                                        @foreach (PhoneNumber phoneNumber in person.PhoneNumbers)
                                        {
                                            <MudGrid>
                                                <MudItem sm="12" md="6" lg="4">
                                                    <MudTextField Label="Number" @bind-Value="phoneNumber.Number" Required="true" />
                                                </MudItem>
                                                <MudItem sm="12" md="6" lg="4">
                                                    <MudSelect @bind-Value="phoneNumber.Type" Variant="Variant.Filled" Label="Type" AnchorOrigin="Origin.BottomCenter" RequiredError="Type must be selected">
                                                        @foreach (PhoneNumberTypeEnum phoneNumberType in Enum.GetValues(typeof(PhoneNumberTypeEnum)))
                                                        {
                                                            <MudSelectItem Value="phoneNumberType">@phoneNumberType</MudSelectItem>
                                                        }
                                                    </MudSelect>
                                                </MudItem>
                                            </MudGrid>
                                        }
                                    </MudItem>
                                }

                            </MudGrid>
                        </MudCard>
                    </MudListItem>
                }
            </MudList>
        </MudItem>
    </MudGrid>
</MudForm>

<MudCard class="pa-4">
    <MudHidden Breakpoint="Breakpoint.Xs" Invert="true"><MudCard class="pa-1">XS</MudCard></MudHidden>
    <MudHidden Breakpoint="Breakpoint.Sm" Invert="true"><MudCard class="pa-1">SM</MudCard></MudHidden>
    <MudHidden Breakpoint="Breakpoint.Md" Invert="true"><MudCard class="pa-1">MD</MudCard></MudHidden>
    <MudHidden Breakpoint="Breakpoint.Lg" Invert="true"><MudCard class="pa-1">LG</MudCard></MudHidden>
    <MudHidden Breakpoint="Breakpoint.Xl" Invert="true"><MudCard class="pa-1">XL</MudCard></MudHidden>
    <MudHidden Breakpoint="Breakpoint.Xxl" Invert="true"><MudCard class="pa-1">XXL</MudCard></MudHidden>
</MudCard>
@code {
    bool _success;
    string[] _errors = { };
    MudForm _form;

    readonly Report _report = new();

    class Report
    {
        public Report()
        {
            Location = new Location { LocationType = LocationType.Incident };
        }

        public DateTime? Date { get; set; } = DateTime.Now;
        public TimeSpan? Time { get; set; }
        public Agency Agency { get; set; }
        public IncidentType IncidentType { get; set; }
        public double? Miles { get; set; }
        public Location Location { get; set; }

        public IList<ReportPerson> People { get; set; } = new List<ReportPerson>();
    }

    public class Location
    {
        public string Address { get; set; }
        public string City { get; set; }
        public string State { get; set; }
        public string Zip { get; set; }
        public LocationType LocationType { get; set; } = LocationType.Default;
    }

    public enum LocationType
    {
        Home,
        Incident,
        Default
    }

    public class PhoneNumber
    {
        public string Number { get; set; }
        public PhoneNumberTypeEnum Type { get; set; }

    }

    public enum PhoneNumberTypeEnum
    {
        Home,
        Work,
        Mobile
    }

    public class ReportPerson : Person
    {

        public DateTime? DateOfBirth { get; set; }

        public IList<Location> Locations { get; set; } = new List<Location>();

        public PersonType Type { get; set; }

        public bool AllowPhoneNumber() => this.Type != PersonType.Victim;
    }

    public enum PersonType
    {
        Victim,
        Spouse,
        Child,
        Witness,
        Parent,
        Other
    }

    public class Person
    {
        public int Id { get; set; }

        public string FirstName { get; set; }

        public string LastName { get; set; }

        public string FullName => $"{FirstName} {LastName}".Trim();

        public override string ToString() => FullName;

        public IList<PhoneNumber> PhoneNumbers { get; set; } = new List<PhoneNumber>();
    }

    readonly List<Agency> _agencies = new()
{
        new Agency(1, "Agency 1") { RequiresTime = true },
        new Agency(2, "Agency 2") { RequiresTime = true },
        new Agency(3, "Agency 3") { RequiresTime = false },
        new Agency(4, "Agency 4") { RequiresTime = false }
    };

    readonly List<IncidentType> _incidentTypes = (new List<IncidentType>()
{
        new IncidentType { Id = 1, Name = "Death Call" },
        new IncidentType { Id = 2, Name = "Administration" },
        new IncidentType { Id = 3, Name = "Training" },
        new IncidentType { Id = 4, Name = "Other" },
        new IncidentType { Id = 5, Name = "Crisis Call" },
    }).OrderBy(_ => _.Name).ToList();

    public class Agency
    {
        public Agency(int id, string name)
        {
            Id = id;
            Name = name;
        }

        public string Name { get; set; }

        public int Id { get; set; }

        public bool RequiresTime { get; set; }

        public override int GetHashCode()
        {
            return Id;
        }

        public override bool Equals(object obj)
        {
            return obj is Agency agency && agency.Id == Id;
        }

        public override string ToString()
        {
            return Name;
        }
    }

    public class IncidentType
    {
        public string Name { get; set; }

        public int Id { get; set; }

        public override int GetHashCode()
        {
            return Id;
        }

        public override bool Equals(object obj)
        {
            return obj is IncidentType incidentType && incidentType.Id == Id;
        }

        public override string ToString()
        {
            return Name;
        }
    }

    private void AddPerson()
    {
        var newPerson = new ReportPerson()
        {
            Type = this._report.People.Count == 0 ? PersonType.Victim : PersonType.Other,
            PhoneNumbers = new List<PhoneNumber>
    {
                new PhoneNumber()
            }
        };

        this._report.People.Add(newPerson);
        StateHasChanged();
    }

}